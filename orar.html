<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Orar FMI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="orar facultate matematica informatica universitate bucuresti fmi">
    <meta name="author" content="Caruceru Cristian">
    <meta name="copyright" content="Caruceru Cristian">
    <base href="http://orar5-fmi5unibuc.rhcloud.com/">
    <!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
    <!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
    <!--script src="js/less-1.3.3.min.js"></script-->
    <!--append ‘#!watch’ to the browser URL, then refresh the page. -->

    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="img/favicon.png">
    <style>
        #currentimage {
            -webkit-transition: all 1s ease; /* Safari and Chrome */
            -moz-transition: all 1s ease; /* Firefox */
            -ms-transition: all 1s ease; /* IE 9 */
            -o-transition: all 1s ease; /* Opera */
            transition: all 1s ease;
        }

        #currentimage:hover {
            -webkit-transform: scale(1.25); /* Safari and Chrome */
            -moz-transform: scale(1.25); /* Firefox */
            -ms-transform: scale(1.25); /* IE 9 */
            -o-transform: scale(1.25); /* Opera */
            transform: scale(1.25);
        }
    </style>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script>
        var oldNames = {};
        var currentNames = {};
        var currentTime = getCurrentTime();
        var lastKnownGoodConfiguration = {
            nr: "1",
            type: "0",
            studSauProf: "studenti",
            an: currentTime.year,
            semestru: currentTime.semester
        };
        $(document).ready(function () {
            $("#currentimage").attr("src", "http://orar4-fmi4unibuc.rhcloud.com/api/orar/getimage?nr=1&type=0");
            $.getJSON("http://orar4-fmi4unibuc.rhcloud.com/api/orar/getallnames", function (data) {
                var itemsStudenti = [];
                var itemsProfesori = [];
                var grupe = data.grupe;
                var profesori = data.profesori;
                $.extend(currentNames, {
                    grupe: []
                });
                $.each(grupe, function (key, val) {
                    var str = "<option value='" + key + "'>" + val + "</option>";
                    currentNames.grupe.push(str);
                    itemsStudenti.push(str)
                });
                $.extend(currentNames, {
                    profesori: []
                });
                $.each(profesori, function (key, val) {
                    var str = "<option value='" + key + "'>" + val + "</option>";
                    currentNames.profesori.push(str);
                    itemsProfesori.push(str)
                });
                $(itemsStudenti.join("")).appendTo($("#studentilist"));
                $(itemsProfesori.join("")).appendTo($("#profesorilist"));
                $("#studentilist").change(function () {
                    var element = $(this).children(":selected")[0];
                    changeImage(element.value, "studenti", null, null)
                });
                $("#profesorilist").change(function () {
                    var element = $(this).children(":selected")[0];
                    changeImage(element.value, "profesori", null, null)
                });
                $("#saptamanalist").change(function () {
                    var element = $(this).children(":selected")[0];
                    changeImage(element.value, "saptamana", null, null)
                })
            });
            $.getJSON("http://orar4-fmi4unibuc.rhcloud.com/api/orar/getalloldnames", function (data) {
                var ani = [];
                workingData = aniSort(data);
                createOldData(workingData);
                var containsCurrentYear = false;
                $.each(workingData, function (key, array) {
                    if (key == currentTime.year) {
                        containsCurrentYear = true
                    }
                    var result = key.split("_");
                    ani.push("<option value='" + key + "'>" + result[0] + "-" + result[1] + "</option>")
                });
                if (containsCurrentYear == false) {
                    var afterSplit = currentTime.year.split("_");
                    ani.unshift("<option value='" + currentTime.year + "'>" + afterSplit[0] + "-" + afterSplit[1] + "</option>")
                }
                $(ani.join("")).appendTo($("#anilist"));
                $("#anilist").change(function () {
                    var element = $(this).children(":selected")[0];
                    changeImage(null, null, element.value, null)
                });
                $("#semestrulist").val(currentTime.semester);
                $("#semestrulist").change(function () {
                    var element = $(this).children(":selected")[0];
                    changeImage(null, null, null, element.value)
                })
            })
        });
        function changeImage(nr, type, an, semestru) {
            if (nr == null && type == null) {
                if (semestru == null && an != currentTime.year) {
                    lastKnownGoodConfiguration.an = an;
                    setOldImage(an, lastKnownGoodConfiguration.semestru, lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, lastKnownGoodConfiguration.type, true)
                } else if (semestru != null && (lastKnownGoodConfiguration.an != currentTime.year || (lastKnownGoodConfiguration.an == currentTime.year && semestru != currentTime.semester))) {
                    lastKnownGoodConfiguration.semestru = semestru;
                    setOldImage(lastKnownGoodConfiguration.an, semestru, lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, lastKnownGoodConfiguration.type, true)
                } else if (semestru != null && semestru == currentTime.semester && lastKnownGoodConfiguration.an == currentTime.year) {
                    lastKnownGoodConfiguration.semestru = semestru;
                    setNewImage(lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, lastKnownGoodConfiguration.type, true)
                } else if (semestru == null && an == currentTime.year && lastKnownGoodConfiguration.semestru == currentTime.semester) {
                    lastKnownGoodConfiguration.an = an;
                    setNewImage(lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, lastKnownGoodConfiguration.type, true)
                } else if (semestru == null && an == currentTime.year && lastKnownGoodConfiguration.semestru != currentTime.semester) {
                    lastKnownGoodConfiguration.an = an;
                    setOldImage(an, lastKnownGoodConfiguration.semestru, lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, lastKnownGoodConfiguration.type, true)
                }
            } else {
                if (lastKnownGoodConfiguration.an == currentTime.year && lastKnownGoodConfiguration.semestru == currentTime.semester) {
                    var orice = type;
                    if (orice == "studenti" || orice == "profesori") {
                        lastKnownGoodConfiguration.nr = nr;
                        lastKnownGoodConfiguration.studSauProf = orice;
                        setNewImage(nr, orice, lastKnownGoodConfiguration.type, false)
                    } else if (orice == "saptamana") {
                        lastKnownGoodConfiguration.type = nr;
                        setNewImage(lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, nr, false)
                    }
                } else {
                    var orice = type;
                    if (orice == "studenti" || orice == "profesori") {
                        lastKnownGoodConfiguration.nr = nr;
                        lastKnownGoodConfiguration.studSauProf = orice;
                        setOldImage(lastKnownGoodConfiguration.an, lastKnownGoodConfiguration.semestru, nr, orice, lastKnownGoodConfiguration.type, false)
                    } else if (orice == "saptamana") {
                        lastKnownGoodConfiguration.type = nr;
                        setOldImage(lastKnownGoodConfiguration.an, lastKnownGoodConfiguration.semestru, lastKnownGoodConfiguration.nr, lastKnownGoodConfiguration.studSauProf, nr, false)
                    }
                }
            }
        }
        function setOldImage(an, semestru, nr, studSauProf, type, is_change) {
            if (is_change) {
                var sem = semestru == 0 ? "semI" : "semII";
                var selected = $("#studentilist").val();
                $("#studentilist").empty();
                $(oldNames[an][sem].grupe.join("")).appendTo($("#studentilist"));
                $("#studentilist").val(selected);
                selected = $("#profesorilist").val();
                $("#profesorilist").empty();
                $(oldNames[an][sem].profesori.join("")).appendTo($("#profesorilist"));
                $("#profesorilist").val(selected)
            }
            if (studSauProf == "studenti") {
                $("#currentimage").attr("src", "http://orar4-fmi4unibuc.rhcloud.com/api/orar/getoldimage?nr=" + nr + "&type=" + type + "&an=" + an + "&sem=" + semestru)
            } else {
                switch (type) {
                    case "0":
                        $("#currentimage").attr("src", "http://orar-fmiunibuc.rhcloud.com/api/orar/getoldimage?nr=" + nr + "&an=" + an + "&sem=" + semestru);
                        break;
                    case "1":
                        $("#currentimage").attr("src", "http://orar2-fmi2unibuc.rhcloud.com/api/orar/getoldimage?nr=" + nr + "&an=" + an + "&sem=" + semestru);
                        break;
                    case "2":
                        $("#currentimage").attr("src", "http://orar3-clonaion.rhcloud.com/api/orar/getoldimage?nr=" + nr + "&an=" + an + "&sem=" + semestru);
                        break;
                    default:
                        break
                }
            }
        }
        function setNewImage(nr, studSauProf, type, is_change) {
            if (is_change) {
                var selected = $("#studentilist").val();
                $("#studentilist").empty();
                $(currentNames.grupe.join("")).appendTo($("#studentilist"));
                $("#studentilist").val(selected);
                selected = $("#profesorilist").val();
                $("#profesorilist").empty();
                $(currentNames.profesori.join("")).appendTo($("#profesorilist"));
                $("#profesorilist").val(selected)
            }
            lastKnownGoodConfiguration.type = type;
            lastKnownGoodConfiguration.nr = nr;
            lastKnownGoodConfiguration.studSauProf = studSauProf;
            if (studSauProf == "studenti") {
                $("#currentimage").attr("src", "http://orar4-fmi4unibuc.rhcloud.com/api/orar/getimage?nr=" + nr + "&type=" + lastKnownGoodConfiguration.type)
            } else if (studSauProf == "profesori") {
                switch (type) {
                    case "0":
                        $("#currentimage").attr("src", "http://orar-fmiunibuc.rhcloud.com/api/orar/getimage?nr=" + nr);
                        break;
                    case "1":
                        $("#currentimage").attr("src", "http://orar2-fmi2unibuc.rhcloud.com/api/orar/getimage?nr=" + nr);
                        break;
                    case "2":
                        $("#currentimage").attr("src", "http://orar3-clonaion.rhcloud.com/api/orar/getimage?nr=" + nr);
                        break;
                    default:
                        break
                }
            }
        }
        function createOldData(data) {
            $.each(data, function (year, array) {
                if (array.length > 0 && array[0] != null) {
                    oldNames[year] = {};
                    $.extend(oldNames[year], {
                        semI: {}
                    });
                    $.extend(oldNames[year].semI, {
                        grupe: []
                    });
                    $.each(array[0].grupe, function (id, name) {
                        oldNames[year].semI.grupe.push("<option value='" + id + "'>" + name + "</option>")
                    });
                    $.extend(oldNames[year].semI, {
                        profesori: []
                    });
                    $.each(array[0].profesori, function (id, name) {
                        oldNames[year].semI.profesori.push("<option value='" + id + "'>" + name + "</option>")
                    })
                }
                if (array.length > 1 && array[1] != null) {
                    if (!oldNames.hasOwnProperty(year)) {
                        oldNames[year] = {}
                    }
                    $.extend(oldNames[year], {
                        semII: {}
                    });
                    $.extend(oldNames[year].semII, {
                        grupe: []
                    });
                    $.each(array[1].grupe, function (id, name) {
                        oldNames[year].semII.grupe.push("<option value='" + id + "'>" + name + "</option>")
                    });
                    $.extend(oldNames[year].semII, {
                        profesori: []
                    });
                    $.each(array[1].profesori, function (id, name) {
                        oldNames[year].semII.profesori.push("<option value='" + id + "'>" + name + "</option>")
                    })
                }
            })
        }
        function aniSort(data) {
            var keys = [],
                    key,
                    workingData = new Object();
            for (key in data) {
                if (data.hasOwnProperty(key)) {
                    keys.push(key)
                }
            }
            keys.sort().reverse();
            for (var i = 0; i < keys.length; i++) {
                key = keys[i];
                workingData[key] = data[key]
            }
            return workingData
        }
        function getCurrentTime() {
            var current_year = new Date().getFullYear();
            var current_month = new Date().getMonth() + 1;
            var an;
            var semestru;
            if (current_month >= 2 && current_month < 9) {
                an = (current_year - 1).toString() + "_" + current_year.toString();
                semestru = "1"
            } else {
                if (current_month >= 9 && current_month <= 12) {
                    an = current_year.toString() + "_" + (current_year + 1).toString()
                } else {
                    an = (current_year - 1).toString() + "_" + current_year.toString()
                }
                semestru = "0"
            }
            return {
                year: an,
                semester: semestru
            }
        }
    </script>
    <style type="text/css">
        form {
            margin-top: 20px;
        }
    </style>
</head>

<body>
<div class="col-md-4 column">
    <form>
        <div class="form-group">
            <label for="studenti">Grupa:</label>
            <select name="studenti" class="form-control" id="studentilist">
            </select>
        </div>
        <div class="form-group">
            <label for="profesori">Profesor:</label>
            <select name="profesori" class="form-control" id="profesorilist">
            </select>
        </div>
        <div class="form-group">
            <label for="saptamana">Săptămână:</label>
            <select name="saptamana" class="form-control" id="saptamanalist">
                <option value="0">Toate saptamanile</option>
                <option value="1">Impară</option>
                <option value="2">Pară</option>
            </select>
        </div>
        <div class="form-group">
            <label for="an">An universitar:</label>
            <select name="an" class="form-control" id="anilist">
            </select>
        </div>
        <div class="form-group">
            <label for="semestru">Semestru:</label>
            <select name="semestru" class="form-control" id="semestrulist">
                <option value="0">Semestrul I</option>
                <option value="1">Semestrul II</option>
            </select>
        </div>
        <form/>
</div>
<div class="col-md-8 column">
    <img id="currentimage" alt="orar" width="100%" src="about:blank">
</div>
</body>
</html>
